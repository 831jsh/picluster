version: '3'
services:

  server:
    image: "node:alpine"
    volumes:
      - .:/picluster
      - ./docker-compose.config.json:/picluster/config.json
    networks:
      picluster:
        ipv4_address: 10.10.10.1
    ports:
      - "3000:3000"
    working_dir: /picluster/server
    command: ["sh", "-c", "set -e;printf '127.0.0.1\tagent\n' | tee -a /etc/hosts;printf '127.0.0.1\tserver\n' | tee -a /etc/hosts;npm install --production;node server.js;"]
  agent:
    image: "node:alpine"
    volumes:
      - .:/picluster
      - ./docker-compose.config.json:/picluster/config.json
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      picluster:
        ipv4_address: 10.10.10.2
    ports:
      - "3001:3001"
    working_dir: /picluster/agent
    command: ["sh", "-c", "set -e;printf '127.0.0.1\tagent\n' | tee -a /etc/hosts;printf '127.0.0.1\tserver\n' | tee -a /etc/hosts;apk update;apk upgrade;apk add git python make g++ docker procps;export PATH=/bin:$PATH;npm install --production;node agent.js"]

  webconsole:
    image: "node:alpine"
    networks:
      picluster:
        ipv4_address: 10.10.10.3
    volumes:
      - .:/picluster
      - ./docker-compose.config.json:/picluster/config.json
    ports:
      - "3003:3003"
    working_dir: /picluster/web
    command: ["sh", "-c", "set -e;printf '127.0.0.1\tagent\n' | tee -a /etc/hosts;printf '127.0.0.1\tserver\n' | tee -a /etc/hosts;apk update;apk upgrade;apk add git;npm install --production;node webconsole.js;"]

networks:
  picluster:
    driver: bridge
    ipam:
     config:
       - subnet: 10.10.10.0/16
